# README:
# This patch allows testing of the intel-gpu-plugin with a simulated GPU in Kubernetes.
# The FAKEDRI_SPEC environment variable simulates an Intel DG1 GPU, enabling testing
# of GPU-based workload allocations without requiring real GPU hardware.
# It also mounts /tmp as a volume for temporary file storage.
#
# To apply this patch, run the following command:
# kubectl patch daemonset intel-gpu-plugin -n <namespace> --patch "$(cat fakedri-patch.yaml)"
# Replace <namespace> with the appropriate namespace (e.g., kube-system).

spec:
  template:
    spec:
      containers:
      - name: intel-gpu-plugin
        env:
        # FAKEDRI_SPEC simulates an Intel DG1 GPU with specific hardware specs for testing.
        - name: FAKEDRI_SPEC
          value: |
            Info: "8x 4 GiB DG1 [Iris Xe MAX Graphics] GPUs"  # Describes the fake GPU model
            DevCount: 8  # The number of fake GPUs being simulated (8 devices)
            TilesPerDev: 1  # Number of tiles per fake GPU (1 tile per device)
            DevsPerNode: 1  # Number of GPUs per node (1 GPU per numa node)
            DevMemSize: 4294967296  # Memory size per GPU in bytes (4 GiB = 4294967296 bytes)
            Driver: "i915"  # The GPU driver to use for the fake device (i915, used for Intel GPUs)
            Capabilities:  # List of capabilities that the fake GPU supports
              platform: "fake_DG1"  # Fake platform name (simulates the DG1 platform)
              connections: ""  # Placeholder for GPU connections (manual connections for xe-link)
              connection-topology: "FULL"  # Defines the connection xe-link topology of the GPU
        # Mount the /tmp directory from the host to the container
        volumeMounts:
        - name: tmp
          mountPath: /tmp  # The container's /tmp directory is mapped to the host's /tmp directory
      volumes:
      - name: tmp
        hostPath:
          path: /tmp  # Mount the host's /tmp directory inside the container
          type: DirectoryOrCreate  # Create the directory if it does not already exist
